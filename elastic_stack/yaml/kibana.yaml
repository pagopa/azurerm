apiVersion: kibana.k8s.elastic.co/v1
kind: Kibana
metadata:
  name: quickstart
  namespace: elastic-system
spec:
  version: 8.1.2
  count: 1
  elasticsearchRef:
    name: quickstart
  podTemplate:
    spec:
      nodeSelector:
        elastic: eck
  http:
    tls:
      selfSignedCertificate:
        disabled: true
  config:
    server.basePath: /kibana
    server.rewriteBasePath: false
    server.publicBaseUrl: ${external_domain}
    server.name: "kibana"
    csp.strict: false
    xpack.fleet.agents.elasticsearch.hosts: ["https://elasticsearch-quickstart-es-http.default.svc:9200"]
    #xpack.fleet.agents.fleet_server.hosts: ["https://fleet-server-quickstart-agent-http.default.svc:8220"]
    xpack.fleet.packages:
      # - name: system
      #   version: latest
      - name: elastic_agent
        version: latest
      # - name: fleet_server
      #   version: latest
      - name: kubernetes
        version: latest
      - name: apm
        version: latest
    xpack.fleet.agentPolicies:
      # - name: Fleet Server on ECK policy
      #   id: eck-fleet-server
      #   is_default_fleet_server: true
      #   namespace: fleet_agent
      #   monitoring_enabled:
      #     - logs
      #     - metrics
      #   unenroll_timeout: 900
      #   package_policies:
      #   - name: fleet_server-1
      #     id: fleet_server-1
      #     package:
      #       name: fleet_server
      - name: Elastic Agent on ECK policy
        id: eck-agent
        namespace: eck_agent
        monitoring_enabled:
          - logs
          - metrics
        unenroll_timeout: 900
        is_default: true
        package_policies:
        #- package:
        #    name: system
        #  name: system-1
        %{~ for k, v in agent_config_container_logs ~}
        - id: kubernetes-${k}
          name: kubernetes-${k}
          namespace: ${v.data_stream_namespace}
          package:
            name: kubernetes
          enabled: true
          # inputs:
          # - policy_template: kubelet
          #   streams:
          #   - data_stream:
          #       type: metrics
          #       dataset: kubernetes.container
          #     vars:
          #       period:
          #         type: text
          #         value: 10s
          #       add_metadata:
          #         type: bool
          #         value: true
          #       hosts:
          #         type: text
          #         value:
          #         - https://$${env.NODE_NAME}:10250
          #       ssl.verification_mode:
          #         type: text
          #         value: none
          #       add_resource_metadata_config:
          #         type: yaml
          #         value: |
          #           # add_resource_metadata:
          #           #   namespace:
          #           #     include_labels: ["namespacelabel1"]
          #           #   node:
          #           #     include_labels: ["nodelabel2"]
          #           #     include_annotations: ["nodeannotation1"]
          #           #   deployment: false
          #       ssl.certificate_authorities:
          #         type: text
          #         value: []
          #       bearer_token_file:
          #         type: text
          #         value: "/var/run/secrets/kubernetes.io/serviceaccount/token"
          #     id: kubernetes/metrics-kubernetes.container-kubernetes-${v.id}
          #     enabled: false
          #   - data_stream:
          #       type: metrics
          #       dataset: kubernetes.node
          #     vars:
          #       period:
          #         type: text
          #         value: 10s
          #       add_metadata:
          #         type: bool
          #         value: true
          #       hosts:
          #         type: text
          #         value:
          #         - https://$${env.NODE_NAME}:10250
          #       ssl.verification_mode:
          #         type: text
          #         value: none
          #       ssl.certificate_authorities:
          #         type: text
          #         value: []
          #       bearer_token_file:
          #         type: text
          #         value: "/var/run/secrets/kubernetes.io/serviceaccount/token"
          #     id: kubernetes/metrics-kubernetes.node-kubernetes-${v.id}
          #     enabled: false
          #   - data_stream:
          #       type: metrics
          #       dataset: kubernetes.pod
          #     vars:
          #       period:
          #         type: text
          #         value: 10s
          #       add_metadata:
          #         type: bool
          #         value: true
          #       hosts:
          #         type: text
          #         value:
          #         - https://$${env.NODE_NAME}:10250
          #       ssl.verification_mode:
          #         type: text
          #         value: none
          #       add_resource_metadata_config:
          #         type: yaml
          #         value: |
          #           # add_resource_metadata:
          #           #   namespace:
          #           #     include_labels: ["namespacelabel1"]
          #           #   node:
          #           #     include_labels: ["nodelabel2"]
          #           #     include_annotations: ["nodeannotation1"]
          #           #   deployment: false
          #       ssl.certificate_authorities:
          #         type: text
          #         value: []
          #       bearer_token_file:
          #         type: text
          #         value: "/var/run/secrets/kubernetes.io/serviceaccount/token"
          #     id: kubernetes/metrics-kubernetes.pod-kubernetes-${v.id}
          #     enabled: false
          #   - data_stream:
          #       type: metrics
          #       dataset: kubernetes.system
          #     vars:
          #       period:
          #         type: text
          #         value: 10s
          #       add_metadata:
          #         type: bool
          #         value: true
          #       hosts:
          #         type: text
          #         value:
          #         - https://$${env.NODE_NAME}:10250
          #       ssl.verification_mode:
          #         type: text
          #         value: none
          #       ssl.certificate_authorities:
          #         type: text
          #         value: []
          #       bearer_token_file:
          #         type: text
          #         value: "/var/run/secrets/kubernetes.io/serviceaccount/token"
          #     id: kubernetes/metrics-kubernetes.system-kubernetes-${v.id}
          #     enabled: false
          #   - data_stream:
          #       type: metrics
          #       dataset: kubernetes.volume
          #     vars:
          #       period:
          #         type: text
          #         value: 10s
          #       add_metadata:
          #         type: bool
          #         value: true
          #       hosts:
          #         type: text
          #         value:
          #         - https://$${env.NODE_NAME}:10250
          #       ssl.verification_mode:
          #         type: text
          #         value: none
          #       ssl.certificate_authorities:
          #         type: text
          #         value: []
          #       bearer_token_file:
          #         type: text
          #         value: "/var/run/secrets/kubernetes.io/serviceaccount/token"
          #     id: kubernetes/metrics-kubernetes.volume-kubernetes-${v.id}
          #     enabled: false
          #   type: kubernetes/metrics
          #   enabled: false
          # - policy_template: kube-state-metrics
          #   streams:
          #   - data_stream:
          #       type: metrics
          #       dataset: kubernetes.state_container
          #     vars:
          #       node:
          #         type: text
          #       period:
          #         type: text
          #         value: 10s
          #       add_metadata:
          #         type: bool
          #         value: true
          #       hosts:
          #         type: text
          #         value:
          #         - kube-state-metrics:8080
          #       leaderelection:
          #         type: bool
          #         value: true
          #       namespace:
          #         type: text
          #       add_resource_metadata_config:
          #         type: yaml
          #         value: |
          #           # add_resource_metadata:
          #           #   namespace:
          #           #     include_labels: ["namespacelabel1"]
          #           #   node:
          #           #     include_labels: ["nodelabel2"]
          #           #     include_annotations: ["nodeannotation1"]
          #           #   deployment: false
          #       ssl.certificate_authorities:
          #         type: text
          #         value: []
          #       bearer_token_file:
          #         type: text
          #         value: "/var/run/secrets/kubernetes.io/serviceaccount/token"
          #     id: kubernetes/metrics-kubernetes.state_container-kubernetes-${v.id}
          #     enabled: false
          #   - data_stream:
          #       type: metrics
          #       dataset: kubernetes.state_cronjob
          #     vars:
          #       node:
          #         type: text
          #       period:
          #         type: text
          #         value: 10s
          #       add_metadata:
          #         type: bool
          #         value: true
          #       hosts:
          #         type: text
          #         value:
          #         - kube-state-metrics:8080
          #       leaderelection:
          #         type: bool
          #         value: true
          #       namespace:
          #         type: text
          #       ssl.certificate_authorities:
          #         type: text
          #         value: []
          #       bearer_token_file:
          #         type: text
          #         value: "/var/run/secrets/kubernetes.io/serviceaccount/token"
          #     id: kubernetes/metrics-kubernetes.state_cronjob-kubernetes-${v.id}
          #     enabled: false
          #   - data_stream:
          #       type: metrics
          #       dataset: kubernetes.state_daemonset
          #     vars:
          #       node:
          #         type: text
          #       period:
          #         type: text
          #         value: 10s
          #       add_metadata:
          #         type: bool
          #         value: true
          #       hosts:
          #         type: text
          #         value:
          #         - kube-state-metrics:8080
          #       leaderelection:
          #         type: bool
          #         value: true
          #       namespace:
          #         type: text
          #       ssl.certificate_authorities:
          #         type: text
          #         value: []
          #       bearer_token_file:
          #         type: text
          #         value: "/var/run/secrets/kubernetes.io/serviceaccount/token"
          #     id: kubernetes/metrics-kubernetes.state_daemonset-kubernetes-${v.id}
          #     enabled: false
          #   - data_stream:
          #       type: metrics
          #       dataset: kubernetes.state_deployment
          #     vars:
          #       node:
          #         type: text
          #       period:
          #         type: text
          #         value: 10s
          #       add_metadata:
          #         type: bool
          #         value: true
          #       hosts:
          #         type: text
          #         value:
          #         - kube-state-metrics:8080
          #       leaderelection:
          #         type: bool
          #         value: true
          #       namespace:
          #         type: text
          #       ssl.certificate_authorities:
          #         type: text
          #         value: []
          #       bearer_token_file:
          #         type: text
          #         value: "/var/run/secrets/kubernetes.io/serviceaccount/token"
          #     id: kubernetes/metrics-kubernetes.state_deployment-kubernetes-${v.id}
          #     enabled: false
          #   - data_stream:
          #       type: metrics
          #       dataset: kubernetes.state_job
          #     vars:
          #       node:
          #         type: text
          #       period:
          #         type: text
          #         value: 10s
          #       add_metadata:
          #         type: bool
          #         value: true
          #       hosts:
          #         type: text
          #         value:
          #         - kube-state-metrics:8080
          #       leaderelection:
          #         type: bool
          #         value: true
          #       namespace:
          #         type: text
          #       ssl.certificate_authorities:
          #         type: text
          #         value: []
          #       bearer_token_file:
          #         type: text
          #         value: "/var/run/secrets/kubernetes.io/serviceaccount/token"
          #     id: kubernetes/metrics-kubernetes.state_job-kubernetes-${v.id}
          #     enabled: false
          #   - data_stream:
          #       type: metrics
          #       dataset: kubernetes.state_node
          #     vars:
          #       node:
          #         type: text
          #       period:
          #         type: text
          #         value: 10s
          #       add_metadata:
          #         type: bool
          #         value: true
          #       hosts:
          #         type: text
          #         value:
          #         - kube-state-metrics:8080
          #       leaderelection:
          #         type: bool
          #         value: true
          #       namespace:
          #         type: text
          #       ssl.certificate_authorities:
          #         type: text
          #         value: []
          #       bearer_token_file:
          #         type: text
          #         value: "/var/run/secrets/kubernetes.io/serviceaccount/token"
          #     id: kubernetes/metrics-kubernetes.state_node-kubernetes-${v.id}
          #     enabled: false
          #   - data_stream:
          #       type: metrics
          #       dataset: kubernetes.state_persistentvolume
          #     vars:
          #       node:
          #         type: text
          #       period:
          #         type: text
          #         value: 10s
          #       add_metadata:
          #         type: bool
          #         value: true
          #       hosts:
          #         type: text
          #         value:
          #         - kube-state-metrics:8080
          #       leaderelection:
          #         type: bool
          #         value: true
          #       namespace:
          #         type: text
          #       ssl.certificate_authorities:
          #         type: text
          #         value: []
          #       bearer_token_file:
          #         type: text
          #         value: "/var/run/secrets/kubernetes.io/serviceaccount/token"
          #     id: kubernetes/metrics-kubernetes.state_persistentvolume-kubernetes-${v.id}
          #     enabled: false
          #   - data_stream:
          #       type: metrics
          #       dataset: kubernetes.state_persistentvolumeclaim
          #     vars:
          #       node:
          #         type: text
          #       period:
          #         type: text
          #         value: 10s
          #       add_metadata:
          #         type: bool
          #         value: true
          #       hosts:
          #         type: text
          #         value:
          #         - kube-state-metrics:8080
          #       leaderelection:
          #         type: bool
          #         value: true
          #       namespace:
          #         type: text
          #       ssl.certificate_authorities:
          #         type: text
          #         value: []
          #       bearer_token_file:
          #         type: text
          #         value: "/var/run/secrets/kubernetes.io/serviceaccount/token"
          #     id: kubernetes/metrics-kubernetes.state_persistentvolumeclaim-kubernetes-${v.id}
          #     enabled: false
          #   - data_stream:
          #       type: metrics
          #       dataset: kubernetes.state_pod
          #     vars:
          #       node:
          #         type: text
          #       period:
          #         type: text
          #         value: 10s
          #       add_metadata:
          #         type: bool
          #         value: true
          #       hosts:
          #         type: text
          #         value:
          #         - kube-state-metrics:8080
          #       leaderelection:
          #         type: bool
          #         value: true
          #       namespace:
          #         type: text
          #       add_resource_metadata_config:
          #         type: yaml
          #         value: |
          #           # add_resource_metadata:
          #           #   namespace:
          #           #     include_labels: ["namespacelabel1"]
          #           #   node:
          #           #     include_labels: ["nodelabel2"]
          #           #     include_annotations: ["nodeannotation1"]
          #           #   deployment: false
          #       ssl.certificate_authorities:
          #         type: text
          #         value: []
          #       bearer_token_file:
          #         type: text
          #         value: "/var/run/secrets/kubernetes.io/serviceaccount/token"
          #     id: kubernetes/metrics-kubernetes.state_pod-kubernetes-${v.id}
          #     enabled: false
          #   - data_stream:
          #       type: metrics
          #       dataset: kubernetes.state_replicaset
          #     vars:
          #       node:
          #         type: text
          #       period:
          #         type: text
          #         value: 10s
          #       add_metadata:
          #         type: bool
          #         value: true
          #       hosts:
          #         type: text
          #         value:
          #         - kube-state-metrics:8080
          #       leaderelection:
          #         type: bool
          #         value: true
          #       namespace:
          #         type: text
          #       ssl.certificate_authorities:
          #         type: text
          #         value: []
          #       bearer_token_file:
          #         type: text
          #         value: "/var/run/secrets/kubernetes.io/serviceaccount/token"
          #     id: kubernetes/metrics-kubernetes.state_replicaset-kubernetes-${v.id}
          #     enabled: false
          #   - data_stream:
          #       type: metrics
          #       dataset: kubernetes.state_resourcequota
          #     vars:
          #       node:
          #         type: text
          #       period:
          #         type: text
          #         value: 10s
          #       add_metadata:
          #         type: bool
          #         value: true
          #       hosts:
          #         type: text
          #         value:
          #         - kube-state-metrics:8080
          #       leaderelection:
          #         type: bool
          #         value: true
          #       namespace:
          #         type: text
          #       ssl.certificate_authorities:
          #         type: text
          #         value: []
          #       bearer_token_file:
          #         type: text
          #         value: "/var/run/secrets/kubernetes.io/serviceaccount/token"
          #     id: kubernetes/metrics-kubernetes.state_resourcequota-kubernetes-${v.id}
          #     enabled: false
          #   - data_stream:
          #       type: metrics
          #       dataset: kubernetes.state_service
          #     vars:
          #       node:
          #         type: text
          #       period:
          #         type: text
          #         value: 10s
          #       add_metadata:
          #         type: bool
          #         value: true
          #       hosts:
          #         type: text
          #         value:
          #         - kube-state-metrics:8080
          #       leaderelection:
          #         type: bool
          #         value: true
          #       namespace:
          #         type: text
          #       ssl.certificate_authorities:
          #         type: text
          #         value: []
          #       bearer_token_file:
          #         type: text
          #         value: "/var/run/secrets/kubernetes.io/serviceaccount/token"
          #     id: kubernetes/metrics-kubernetes.state_service-kubernetes-${v.id}
          #     enabled: false
          #   - data_stream:
          #       type: metrics
          #       dataset: kubernetes.state_statefulset
          #     vars:
          #       node:
          #         type: text
          #       period:
          #         type: text
          #         value: 10s
          #       add_metadata:
          #         type: bool
          #         value: true
          #       hosts:
          #         type: text
          #         value:
          #         - kube-state-metrics:8080
          #       leaderelection:
          #         type: bool
          #         value: true
          #       namespace:
          #         type: text
          #       ssl.certificate_authorities:
          #         type: text
          #         value: []
          #       bearer_token_file:
          #         type: text
          #         value: "/var/run/secrets/kubernetes.io/serviceaccount/token"
          #     id: kubernetes/metrics-kubernetes.state_statefulset-kubernetes-${v.id}
          #     enabled: false
          #   - data_stream:
          #       type: metrics
          #       dataset: kubernetes.state_storageclass
          #     vars:
          #       node:
          #         type: text
          #       period:
          #         type: text
          #         value: 10s
          #       add_metadata:
          #         type: bool
          #         value: true
          #       hosts:
          #         type: text
          #         value:
          #         - kube-state-metrics:8080
          #       leaderelection:
          #         type: bool
          #         value: true
          #       namespace:
          #         type: text
          #       ssl.certificate_authorities:
          #         type: text
          #         value: []
          #       bearer_token_file:
          #         type: text
          #         value: "/var/run/secrets/kubernetes.io/serviceaccount/token"
          #     id: kubernetes/metrics-kubernetes.state_storageclass-kubernetes-${v.id}
          #     enabled: false
          #   type: kubernetes/metrics
          #   enabled: false
          # - policy_template: kube-apiserver
          #   streams:
          #   - data_stream:
          #       type: metrics
          #       dataset: kubernetes.apiserver
          #     vars:
          #       period:
          #         type: text
          #         value: 30s
          #       hosts:
          #         type: text
          #         value:
          #         - https://$${env.KUBERNETES_SERVICE_HOST}:$${env.KUBERNETES_SERVICE_PORT}
          #       leaderelection:
          #         type: bool
          #         value: true
          #       ssl.certificate_authorities:
          #         type: text
          #         value:
          #         - "/var/run/secrets/kubernetes.io/serviceaccount/ca.crt"
          #       bearer_token_file:
          #         type: text
          #         value: "/var/run/secrets/kubernetes.io/serviceaccount/token"
          #     id: kubernetes/metrics-kubernetes.apiserver-kubernetes-${v.id}
          #     enabled: false
          #   type: kubernetes/metrics
          #   enabled: false
          # - policy_template: kube-proxy
          #   streams:
          #   - data_stream:
          #       type: metrics
          #       dataset: kubernetes.proxy
          #     vars:
          #       period:
          #         type: text
          #         value: 10s
          #       hosts:
          #         type: text
          #         value:
          #         - localhost:10249
          #     id: kubernetes/metrics-kubernetes.proxy-kubernetes-${v.id}
          #     enabled: false
          #   type: kubernetes/metrics
          #   enabled: false
          # - policy_template: kube-scheduler
          #   streams:
          #   - data_stream:
          #       type: metrics
          #       dataset: kubernetes.scheduler
          #     vars:
          #       period:
          #         type: text
          #         value: 10s
          #       scheduler_label_value:
          #         type: text
          #         value: kube-scheduler
          #       hosts:
          #         type: text
          #         value:
          #         - https://0.0.0.0:10259
          #       ssl.verification_mode:
          #         type: text
          #         value: none
          #       scheduler_label_key:
          #         type: text
          #         value: component
          #       bearer_token_file:
          #         type: text
          #         value: "/var/run/secrets/kubernetes.io/serviceaccount/token"
          #     id: kubernetes/metrics-kubernetes.scheduler-kubernetes-${v.id}
          #     enabled: false
          #   type: kubernetes/metrics
          #   enabled: false
          # - policy_template: kube-controller-manager
          #   streams:
          #   - data_stream:
          #       type: metrics
          #       dataset: kubernetes.controllermanager
          #     vars:
          #       period:
          #         type: text
          #         value: 10s
          #       controller_manager_label_key:
          #         type: text
          #         value: component
          #       hosts:
          #         type: text
          #         value:
          #         - https://0.0.0.0:10257
          #       controller_manager_label_value:
          #         type: text
          #         value: kube-controller-manager
          #       ssl.verification_mode:
          #         type: text
          #         value: none
          #       bearer_token_file:
          #         type: text
          #         value: "/var/run/secrets/kubernetes.io/serviceaccount/token"
          #     id: kubernetes/metrics-kubernetes.controllermanager-kubernetes-${v.id}
          #     enabled: false
          #   type: kubernetes/metrics
          #   enabled: false
          # - policy_template: events
          #   streams:
          #   - data_stream:
          #       type: metrics
          #       dataset: kubernetes.event
          #     vars:
          #       period:
          #         type: text
          #         value: 10s
          #       add_metadata:
          #         type: bool
          #         value: true
          #       leaderelection:
          #         type: bool
          #         value: true
          #       skip_older:
          #         type: bool
          #         value: true
          #     id: kubernetes/metrics-kubernetes.event-kubernetes-${v.id}
          #     enabled: false
          #   type: kubernetes/metrics
          #   enabled: false
          # - policy_template: container-logs
          #   streams:
          #   - compiled_stream:
          #       prospector.scanner.symlinks: true
          #       paths:
          #       - "/var/log/containers/*_${k}_*$${kubernetes.container.id}.log"
          #       parsers:
          #       - container:
          #           stream: all
          #           format: auto
          #     data_stream:
          #       type: logs
          #       dataset: kubernetes.container_logs
          #     vars:
          #       containerParserFormat:
          #         type: text
          #         value: auto
          #       paths:
          #         type: text
          #         value:
          #         - "/var/log/containers/*_${k}_*$${kubernetes.container.id}.log"
          #       additionalParsersConfig:
          #         type: yaml
          #         value: |
          #           # - ndjson:
          #           #     target: json
          #           #     ignore_decoding_error: true
          #           # - multiline:
          #           #     type: pattern
          #           #     pattern: '^\['
          #           #     negate: true
          #           #     match: after
          #       containerParserStream:
          #         type: text
          #         value: all
          #       symlinks:
          #         type: bool
          #         value: true
          #     id: filestream-kubernetes.container_logs-kubernetes-${v.id}
          #     enabled: true
          #   type: filestream
          #   enabled: true
          # - policy_template: audit-logs
          #   streams:
          #   - data_stream:
          #       type: logs
          #       dataset: kubernetes.audit_logs
          #     vars:
          #       paths:
          #         type: text
          #         value:
          #         - "/var/log/kubernetes/kube-apiserver-audit.log"
          #     id: filestream-kubernetes.audit_logs-kubernetes-${v.id}
          #     enabled: false
          #   type: filestream
          #   enabled: false
        %{~ endfor ~}
        - id: apm-1
          name: apm-1
          namespace: apm
          package:
            name: apm
          inputs:
          - type: apm
            enabled: true
            vars:
            - name: host
              value: 0.0.0.0:8200    
    #xpack:
    #  security:
    #    authc:
    #      providers:
    #        saml:
    #          kibana-realm:
    #            order: 0
    #            realm: kibana-realm
    #            description: "Log in with Azure AD"